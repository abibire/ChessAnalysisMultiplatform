name: Build Linux Flatpak

on:
  workflow_dispatch:
  workflow_call:

jobs:
  build-flatpak:
    runs-on: ubuntu-latest
    container:
      image: bilelmoussaoui/flatpak-github-actions:freedesktop-24.08
      options: --privileged
    steps:
      - name: Free up disk space
        run: |
          df -h
          rm -rf /usr/share/dotnet
          rm -rf /opt/ghc
          rm -rf /usr/local/share/boost
          df -h

      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: Build Linux Distributable
        run: ./gradlew createDistributable

      - name: Prepare app files for Flatpak
        run: |
          ls -la composeApp/build/compose/binaries/main/app/
          mkdir -p flatpak-source
          cp -r composeApp/build/compose/binaries/main/app/* flatpak-source/
          ls -la flatpak-source/
          ls -la flatpak-source/bin/ || echo "No bin directory"

      - name: Build Flatpak
        uses: flatpak/flatpak-github-actions/flatpak-builder@v6
        with:
          bundle: ChessAnalysis-linux.flatpak
          manifest-path: com.andrewbibire.chessanalysis.yml
          cache-key: flatpak-builder-${{ github.sha }}

      - name: Upload Flatpak
        uses: actions/upload-artifact@v4
        with:
          name: linux-flatpak
          path: ChessAnalysis-linux.flatpak
