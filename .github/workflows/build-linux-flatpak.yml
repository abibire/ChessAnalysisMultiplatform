name: Build Linux Flatpak

on:
  workflow_dispatch:
  workflow_call:

jobs:
  build-flatpak:
    runs-on: ubuntu-latest
    container:
      image: bilelmoussaoui/flatpak-github-actions:freedesktop-24.08
      options: --privileged
    steps:
      - name: Free up disk space
        run: |
          df -h
          rm -rf /usr/share/dotnet
          rm -rf /opt/ghc
          rm -rf /usr/local/share/boost
          df -h

      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: Build Linux Distributable
        run: ./gradlew createDistributable

      - name: Prepare app files for Flatpak
        run: |
          ls -la composeApp/build/compose/binaries/main/app/
          mkdir -p flatpak-source
          cp -r composeApp/build/compose/binaries/main/app/* flatpak-source/
          ls -la flatpak-source/
          ls -la flatpak-source/bin/ || echo "No bin directory"

      - name: Setup Flathub remote
        run: |
          flatpak remote-add --user --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

      - name: Build Flatpak manually
        run: |
          df -h
          # Configure cache repo to ignore disk space
          mkdir -p .flatpak-builder/cache
          ostree --repo=.flatpak-builder/cache init --mode=bare-user
          ostree --repo=.flatpak-builder/cache config set core.min-free-space-percent 0
          # Build without cache to save space
          flatpak-builder --user --install-deps-from=flathub --force-clean --disable-rofiles-fuse --disable-cache flatpak_app com.andrewbibire.chessanalysis.yml
          # Create bundle directly without intermediate repo export
          flatpak build-bundle --runtime-repo=https://flathub.org/repo/flathub.flatpakrepo . ChessAnalysis-linux.flatpak com.andrewbibire.chessanalysis flatpak_app
          ls -lh ChessAnalysis-linux.flatpak

      - name: Upload Flatpak
        uses: actions/upload-artifact@v4
        with:
          name: linux-flatpak
          path: ChessAnalysis-linux.flatpak
